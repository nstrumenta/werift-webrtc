{"version":3,"file":"webm.js","sourceRoot":"","sources":["../../../../src/processor_old/webm.ts"],"names":[],"mappings":"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","sourcesContent":["import { BinaryLike } from \"crypto\";\nimport Event from \"rx.mini\";\n\nimport { int, PromiseQueue } from \"../../../common/src\";\nimport { RtpPacket } from \"..\";\nimport { dePacketizeRtpPackets } from \"../codec\";\nimport { SupportedCodec, WEBMBuilder } from \"../container/webm\";\nimport { Output } from \"./base\";\n\nexport interface FileIO {\n  writeFile: (path: string, bin: BinaryLike) => Promise<void>;\n  appendFile: (path: string, bin: BinaryLike) => Promise<void>;\n  readFile: (path: string) => Promise<Buffer>;\n}\n\nexport class WebmOutput implements Output {\n  private builder: WEBMBuilder;\n  private queue = new PromiseQueue();\n  private relativeTimestamp = 0;\n  private timestamps: { [pt: number]: TimestampManager } = {};\n  private disposer?: () => void;\n  private cuePoints: CuePoint[] = [];\n  private position = 0;\n  stopped = false;\n\n  constructor(\n    private writer: FileIO,\n    public path: string,\n    public tracks: {\n      width?: number;\n      height?: number;\n      kind: \"audio\" | \"video\";\n      codec: SupportedCodec;\n      clockRate: number;\n      payloadType: number;\n      trackNumber: number;\n    }[],\n    streams?: {\n      rtpStream?: Event<[RtpPacket]>;\n    }\n  ) {\n    this.builder = new WEBMBuilder(tracks);\n\n    tracks.forEach((t) => {\n      this.timestamps[t.payloadType] = new TimestampManager(t.clockRate);\n    });\n\n    this.queue.push(() => this.init());\n\n    if (streams?.rtpStream) {\n      const { unSubscribe } = streams.rtpStream.subscribe((packet) => {\n        this.pushRtpPackets([packet]);\n      });\n      this.disposer = unSubscribe;\n    }\n  }\n\n  private async init() {\n    const staticPart = Buffer.concat([\n      this.builder.ebmlHeader,\n      this.builder.createSegment(),\n    ]);\n    await this.writer.writeFile(this.path, staticPart);\n    this.position += staticPart.length;\n\n    const video = this.tracks.find((t) => t.kind === \"video\");\n    if (video) {\n      this.cuePoints.push(\n        new CuePoint(this.builder, video.trackNumber, 0.0, this.position)\n      );\n    }\n\n    const cluster = this.builder.createCluster(0.0);\n    await this.writer.appendFile(this.path, cluster);\n    this.position += cluster.length;\n  }\n\n  async stop(insertDuration = true) {\n    this.stopped = true;\n    if (this.disposer) {\n      this.disposer();\n    }\n\n    if (!insertDuration) {\n      return;\n    }\n\n    const originStaticPartOffset = Buffer.concat([\n      this.builder.ebmlHeader,\n      this.builder.createSegment(),\n    ]).length;\n    const clusters = (await this.writer.readFile(this.path)).slice(\n      originStaticPartOffset\n    );\n\n    const latestTimestamp = Object.values(this.timestamps).sort(\n      (a, b) => a.relativeTimestamp - b.relativeTimestamp\n    )[0].relativeTimestamp;\n    const duration = this.relativeTimestamp + latestTimestamp;\n    const staticPart = Buffer.concat([\n      this.builder.ebmlHeader,\n      this.builder.createSegment(duration),\n    ]);\n    // durationを挿入したことによるギャップの解消\n    const staticPartGap = staticPart.length - originStaticPartOffset;\n    this.cuePoints.forEach((c) => {\n      c.position += staticPartGap;\n    });\n\n    let cuesSize = 0;\n    let cues = this.builder.createCues(this.cuePoints.map((c) => c.build()));\n    // cuesの最終的なサイズを再帰的に求める\n    while (cuesSize !== cues.length) {\n      cuesSize = cues.length;\n      this.cuePoints.forEach((cue) => {\n        cue.cuesLength += cuesSize;\n      });\n      cues = this.builder.createCues(this.cuePoints.map((c) => c.build()));\n    }\n\n    await this.writer.writeFile(this.path, staticPart);\n    await this.writer.appendFile(this.path, cues);\n    await this.writer.appendFile(this.path, clusters);\n  }\n\n  pushRtpPackets(packets: RtpPacket[]) {\n    if (this.stopped) return;\n    this.queue.push(() => this.onRtpPackets(packets));\n  }\n\n  private async onRtpPackets(packets: RtpPacket[]) {\n    const track = this.tracks.find(\n      (t) => t.payloadType === packets[0].header.payloadType\n    );\n    if (!track) {\n      return;\n    }\n\n    const timestampManager = this.timestamps[track.payloadType];\n\n    const { data, isKeyframe } = dePacketizeRtpPackets(track.codec, packets);\n\n    const tailTimestamp = packets.slice(-1)[0].header.timestamp;\n    timestampManager.update(tailTimestamp);\n\n    if (\n      (track.kind === \"video\" &&\n        timestampManager.relativeTimestamp > 0 &&\n        isKeyframe) ||\n      timestampManager.relativeTimestamp > MaxSinged16Int\n    ) {\n      this.relativeTimestamp += timestampManager.relativeTimestamp;\n\n      const cluster = this.builder.createCluster(this.relativeTimestamp);\n      await this.writer.appendFile(this.path, cluster);\n      this.cuePoints.push(\n        new CuePoint(\n          this.builder,\n          track.trackNumber,\n          this.relativeTimestamp,\n          this.position\n        )\n      );\n      this.position += cluster.length;\n      Object.values(this.timestamps).forEach((t) => t.reset());\n    }\n\n    const block = this.builder.createSimpleBlock(\n      data,\n      isKeyframe,\n      track.trackNumber,\n      timestampManager.relativeTimestamp\n    );\n    await this.writer.appendFile(this.path, block);\n    this.position += block.length;\n    const [cuePoint] = this.cuePoints.slice(-1);\n    if (cuePoint) {\n      cuePoint.blockNumber++;\n    }\n  }\n}\n\nclass TimestampManager {\n  private baseTimestamp?: number;\n  relativeTimestamp = 0;\n\n  constructor(public clockRate: number) {}\n\n  reset() {\n    this.baseTimestamp = undefined;\n    this.relativeTimestamp = 0;\n  }\n\n  update(tailTimestamp: number) {\n    if (this.baseTimestamp == undefined) {\n      this.baseTimestamp = tailTimestamp;\n    }\n    const rotate =\n      Math.abs(tailTimestamp - this.baseTimestamp) > (Max32Uint / 4) * 3;\n\n    const elapsed = rotate\n      ? tailTimestamp + Max32Uint - this.baseTimestamp\n      : tailTimestamp - this.baseTimestamp;\n\n    this.relativeTimestamp = int((elapsed / this.clockRate) * 1000);\n  }\n}\n\nclass CuePoint {\n  /**\n   * cuesの後のclusterのあるべき位置\n   * cuesはclusterの前に挿入される\n   */\n  cuesLength = 0;\n  blockNumber = 0;\n\n  constructor(\n    private readonly builder: WEBMBuilder,\n    private readonly trackNumber: number,\n    private readonly relativeTimestamp: number,\n    public position: number\n  ) {}\n\n  build() {\n    return this.builder.createCuePoint(\n      this.relativeTimestamp,\n      this.trackNumber,\n      this.position - 48 + this.cuesLength,\n      this.blockNumber\n    );\n  }\n}\n\n/**4294967295 */\nconst Max32Uint = Number(0x01n << 32n) - 1;\n/**32767 */\nconst MaxSinged16Int = (0x01 << 16) / 2 - 1;\n"]}